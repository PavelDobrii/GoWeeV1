# Сервис Delivery Prefetch

## Назначение
Delivery Prefetch хранит краткоживущий кэш аудио-файлов, уже подготовленных TTS-сервисом, чтобы мобильное приложение могло заранее скачать озвучку следующих точек маршрута. Сервис принимает запросы на получение подписанных ссылок CDN и параллельно потребляет события Kafka `tts.completed`.

## Основные возможности
- Ведёт список готовых аудио по `route_id` и выдаёт их клиенту по требованию.
- Формирует подписанные ссылки с ограниченным временем жизни (TTL) на основе общего секрета.
- Слушает Kafka-топик `tts.completed` и обновляет кэш при появлении новых файлов.
- Предоставляет эндпоинты `/healthz`, `/readyz`, `/metrics` для мониторинга.

## HTTP API
| Метод | Путь | Назначение |
| --- | --- | --- |
| `GET` | `/delivery/prefetch?route_id=<id>&next=<n>` | Возвращает до `next` следующих аудио-файлов для маршрута: идентификатор аудио, подписанный URL и TTL. |
| `GET` | `/healthz` | Проверка живости. |
| `GET` | `/readyz` | Проверка готовности. |
| `GET` | `/metrics` | Метрики Prometheus. |

Пример запроса:
```http
GET /delivery/prefetch?route_id=42&next=3
```

## Kafka-топики
| Направление | Топик | Пайлоад |
| --- | --- | --- |
| Consume | `tts.completed` | `{ "route_id": <str>, "story_id": <str>, "audio_id": <int>, ... }` — события о готовности аудио. Ключ сообщения используется как идентификатор аудио. |

Повторные сообщения не приводят к дублированию данных: кэш перезаписывается по ключу аудио.

## Конфигурация
| Переменная | Обязательна | По умолчанию | Описание |
| --- | --- | --- | --- |
| `KAFKA_BROKERS` | Нет | – | Список брокеров Kafka/Redpanda через запятую. При отсутствии потребитель Kafka не запускается. |
| `LINK_TTL_SEC` | Нет | `3600` | Срок жизни подписанного URL в секундах. |
| `SECRET` | Нет | `secret` | Секрет, используемый для генерации подписи (8 символов) в ссылке CDN. |

Переменные можно экспортировать в shell или поместить в `.env`.

## Локальный запуск
1. Установите зависимости:
   ```bash
   cd services/delivery_prefetch
   poetry install
   ```
2. (Опционально) поднимите Kafka и укажите брокеров:
   ```bash
   docker compose up -d redpanda
   export KAFKA_BROKERS=localhost:9092
   ```
3. Запустите сервис:
   ```bash
   poetry run uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload
   ```
4. После получения событий `tts.completed` вызовите `/delivery/prefetch`, чтобы получить список готовых файлов.

## Наблюдаемость
- `/metrics` отдаёт стандартные метрики `JOB_DURATION` и `KAFKA_CONSUMER_LAG` из `src.common.metrics`.
- Для экспорта трассировок можно глобально задать `OTEL_EXPORTER_OTLP_ENDPOINT` (см. общий модуль `src.common.telemetry`).
